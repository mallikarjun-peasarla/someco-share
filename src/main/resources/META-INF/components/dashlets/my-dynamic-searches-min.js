(function(){var p=Alfresco.util.encodeHTML,q=Alfresco.util.activateLinks,f=Alfresco.util.userProfileLink,j=Alfresco.util.siteDashboardLink,l=Alfresco.util.combinePaths,d=Alfresco.util.relativeTime;var a=YAHOO.util.Dom,x=YAHOO.util.Event,s=YAHOO.util.Selector;Alfresco.dashlet.MyDynamicSearches=function t(y){Alfresco.dashlet.MyDynamicSearches.superclass.constructor.call(this,y);this.configDialog=null;return this};Alfresco.dashlet.MyDynamicSearches.generateFilterMarkup=function k(y){var z=Alfresco.util.cleanBubblingObject(y);return YAHOO.lang.substitute("{filterOwner}|{filterId}|{filterData}|{filterDisplay}",z,function(B,C,A){return typeof C==="undefined"?"":window.escape(C)})};Alfresco.dashlet.MyDynamicSearches.generatePathMarkup=function g(z,y){return Alfresco.dashlet.MyDynamicSearches.generateFilterMarkup({filterId:"path",filterData:l(z,y)})};YAHOO.extend(Alfresco.dashlet.MyDynamicSearches,Alfresco.component.SimpleDocList,{PREFERENCES_MYDYNAMICSEARCHES_DASHLET:"org.alfresco.share.MyDynamicSearches.dashlet",PREFERENCES_MYDYNAMICSEARCHES_DASHLET_FILTER_QUERY:"",PREFERENCES_MYDYNAMICSEARCHES_DASHLET_VIEW:"",setHideQueries:function(){if(this.options.hideQueries){a.get(this.id+"-display-query").style.display="none"}else{a.get(this.id+"-display-query").style.display="block"}},setQueries:function(){if(this.options.customQuery!=""){this.widgets.query.set("label",this.options.customQuery);this.widgets.query.value=this.options.customQuery}else{var y=this.options.query;y=Alfresco.util.arrayContains(this.options.validQueryFilter,y)?y:this.options.validQueryFilter[0];if(y!=undefined){if(this.widgets.query){this.widgets.query.set("label",y.label);this.widgets.query.value=y.type}}var y=this.options.defaultQuery;if(y&&this.widgets.query){for(filterNum in this.options.validQueryFilter){if(this.options.validQueryFilter[filterNum].label==this.options.defaultQueryLabel){y=this.options.validQueryFilter[filterNum]}}this.widgets.query.set("label",y.label);this.widgets.query.value=y.type}}},onReady:function v(){this.PREFERENCES_MYDYNAMICSEARCHES_DASHLET_VIEW=this.PREFERENCES_MYDYNAMICSEARCHES_DASHLET+".simpleView";this.buildTitle();this.widgets.query=Alfresco.util.createYUIButton(this,"query",this.onFilterQueryChange,{type:"menu",menu:"query-menu",lazyloadmenu:false});if(this.widgets.query!=null){this.setQueries();this.setHideQueries()}this.widgets.simpleDetailed=new YAHOO.widget.ButtonGroup(this.id+"-simpleDetailed");if(this.widgets.simpleDetailed!==null){this.widgets.simpleDetailed.check(this.options.simpleView?0:1);this.widgets.simpleDetailed.on("checkedButtonChange",this.onSimpleDetailed,this.widgets.simpleDetailed,this)}a.removeClass(s.query(".toolbar div",this.id,true),"hidden");var z=function y(C,B){var A=B[1].anchor;if(A!==null){var D=A.rel,E,F={};if(D&&D!==""){B[1].stop=true;E=D.split("|");F={filterOwner:window.unescape(E[0]||""),filterId:window.unescape(E[1]||""),filterData:window.unescape(E[2]||""),filterDisplay:window.unescape(E[3]||"")};YAHOO.Bubbling.fire("changeFilter",F)}}return true};YAHOO.Bubbling.addDefaultAction("filter-change",z);Alfresco.dashlet.MyDynamicSearches.superclass.onReady.apply(this,arguments)},buildTitle:function o(y){if(a.get(this.id+"-title")){var y=YAHOO.lang.trim(this.options.title);if(!y||y==null||y.length==0){y=this.msg("header.title")}a.get(this.id+"-title").innerHTML=y}},doShowFullscreenPage:function e(A){var y=Alfresco.constants.URL_CONTEXT+"page";var z=this.widgets.query.value.replace(/\\/g,"\\\\");y+="/dynamic-searches?filterPath="+this.options.filterPath+"&filterPathView="+this.options.filterPathView+"&maxItems="+this.options.maxItems+"&simpleView="+this.options.simpleView+"&regionId="+this.options.regionId+"&siteId="+encodeURIComponent(this.options.siteId)+"&containerId="+encodeURIComponent(this.options.containerId)+"&sort="+this.options.sort+"&filterTags="+this.options.filterTags+"&filterCategories="+this.options.filterCategories+"&sortOrder="+this.options.sortOrder+"&query="+encodeURIComponent(z)+"&validQueryFilter="+encodeURIComponent(this.options.validQueryFilter)+"&validSortFilter="+encodeURIComponent(this.options.validSortFilter)+"&title="+this.options.title+"&rootNode="+this.options.rootNode+"&mimetype="+encodeURIComponent(this.options.mimetype)+"&contentType="+encodeURIComponent(this.options.contentType);document.location=y},onConfigDynamicSearchesClick:function b(B){x.stopEvent(B);var C=this;var z=Alfresco.constants.URL_SERVICECONTEXT+"modules/dynamic-searches/config/"+encodeURIComponent(this.options.componentId);if(!this.configDialog){this.configDialog=new Alfresco.module.SimpleDialog(this.id+"-configDialog").setOptions({width:"50em",height:"50em",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/dynamic-searches/config",actionUrl:z,doSetupFormsValidation:{fn:function y(I){I.setShowSubmitStateDynamically(true,false);var D=function(L,K,N){a.get(this.configDialog.id+K).value=N;var O=a.get(this.configDialog.id+L);for(var M=0;M<O.options.length;M++){if(O.options[M].value==N){O.options[M].selected=true}}};var H=document.getElementById(this.configDialog.id+"-customQuery");var E=document.getElementById(this.configDialog.id+"-defaultQuery");var G=document.getElementById(this.configDialog.id+"-sortOrder-list");var J=document.getElementById(this.configDialog.id+"-contentType");YAHOO.util.Event.addListener(a.get(this.id+"-configDialog-clear-customQuery-button"),"click",function(){E.disabled=false;H.value=""});for(var F=0;F<G.options.length;F++){if(G.options[F].value==this.options.sortOrder){G.options[F].selected=true}}if(this.options.customQuery!=undefined&&this.options.customQuery!=""){H.value=this.options.customQuery;E.disabled=true}if(s.query("option",E,false).length==0){E.disabled=true}else{YAHOO.util.Event.addListener(H,"keyup",function(){if(this.value!=""){E.disabled=true}else{E.disabled=false}})}a.get(this.configDialog.id+"-sortOrder").value=this.options.sortOrder;a.get(this.configDialog.id+"-title").value=this.options.title;a.get(this.configDialog.id+"-maxItems").value=this.options.maxItems;a.get(this.configDialog.id+"-filterPath").value=this.options.filterPath;a.get(this.configDialog.id+"-hideQueries").checked=(this.options.hideQueries)?"checked":"";a.get(this.configDialog.id+"-filterPathView").innerHTML=this.options.filterPath.substr(this.options.filterPath.indexOf("|")+1);a.get(this.configDialog.id+"-sort").value=this.options.sort;a.get(this.configDialog.id+"-mimetype").value=this.options.mimetype;a.get(this.configDialog.id+"-contentType").value=this.options.contentType;this.configDialog.widgets.filterPathView=a.get(this.configDialog.id+"-filterPathView");this.configDialog.widgets.filterPathField=a.get(this.configDialog.id+"-filterPath");this.configDialog.widgets.selectFilterPathButton=Alfresco.util.createYUIButton(this.configDialog,"selectFilterPath-button",this.onSelectFilterPath);this.configDialog.widgets.clearFilterPathButton=Alfresco.util.createYUIButton(this.configDialog,"clearFilterPath-button",this.onClearFilterPath);this.configDialog.widgets.filterCategory=new Alfresco.module.ControlWrapper(Alfresco.util.generateDomId()).setOptions({type:"category",name:"filterCategories",container:a.get(this.configDialog.id+"-filterCategoriesSelector"),value:this.options.filterCategories});this.configDialog.widgets.filterTags=new Alfresco.module.ControlWrapper(Alfresco.util.generateDomId()).setOptions({type:"tag",name:"filterTags",container:a.get(this.configDialog.id+"-filterTagsSelector"),value:this.options.filterTags});this.configDialog.widgets.filterCategory.render();this.configDialog.widgets.filterTags.render()},scope:this},onSuccess:{fn:function A(D){var E=D.json;if(E){if((E.customQuery!=this.options.customQuery)){window.location.reload()}else{this.options=YAHOO.lang.merge(this.options,E);this.buildTitle();this.setQueries();this.setHideQueries()}}this.reloadDataTable()},scope:this}})}this.configDialog.setOptions({actionUrl:z,siteId:this.options.siteId,containerId:this.options.containerId}).show()},onSelectFilterPath:function c(A,B){if(!this.widgets.filterPathDialog){this.widgets.filterPathDialog=new Alfresco.module.DoclibGlobalFolder(this.id+"-selectFilterPath");var y=[Alfresco.module.DoclibGlobalFolder.VIEW_MODE_REPOSITORY];this.widgets.filterPathDialog.setOptions({allowedViewModes:y,siteId:this.options.siteId,containerId:this.options.containerId,title:"Configure",nodeRef:this.options.rootNode});YAHOO.Bubbling.on("folderSelected",function(D,C){var E=C[1];if(E!==null){this.widgets.filterPathView.innerHTML=E.selectedFolder.path;this.widgets.filterPathField.value=E.selectedFolder.nodeRef+"|"+E.selectedFolder.path}},this)}var z=this.widgets.filterPathField.value.split("|")[0];this.widgets.filterPathDialog.setOptions({pathNodeRef:z?new Alfresco.util.NodeRef(z):null});this.widgets.filterPathDialog.showDialog()},onClearFilterPath:function m(y){this.widgets.filterPathView.innerHTML="";this.widgets.filterPathField.value=""},getParameters:function i(){var y=this.options.filterPath.substr(0,this.options.filterPath.indexOf("|"));var z="path="+y+"&maxItems="+this.options.maxItems+"&sort="+this.options.sort+"&sortOrder="+this.options.sortOrder+"&filterTags="+this.options.filterTags+"&filterCategories="+this.options.filterCategories+"&rootNode="+this.options.rootNode+"&mimetype="+this.options.mimetype+"&contentType="+this.options.contentType;if(!this.widgets.query){z+="&query="+encodeURIComponent(this.options.query)}else{z+="&query="+encodeURIComponent(this.widgets.query.value)}return z},getWebscriptUrl:function w(){return Alfresco.constants.PROXY_URI+"net/zylk/nodes"},onFilterQueryChange:function u(z,y){var A=y[1];if(A){this.widgets.query.set("label",A.cfg.getProperty("text"));this.widgets.query.value=A.value;this.reloadDataTable()}},onSimpleDetailed:function h(y,z){this.options.simpleView=y.newValue.index===0;this.services.preferences.set(this.PREFERENCES_MYDYNAMICSEARCHES_DASHLET_VIEW,this.options.simpleView);if(y){x.preventDefault(y)}this.reloadDataTable()},renderCellThumbnail:function n(K,M,F,B){var C=40,D=M.getData(),E="";if(D.isInfo){C=52;E='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-docs-bw-32.png" />'}else{var z=D.fileName,G=z.substring(z.lastIndexOf(".")),I=D.location,J=new Alfresco.util.NodeRef(D.nodeRef),L="",H="";if(I.site){L=Alfresco.constants.URL_PAGECONTEXT+"site/"+I.site+"/document-details?nodeRef="+J.toString();H=Alfresco.constants.URL_PAGECONTEXT+"site/"+I.site+"/folder-details?nodeRef="+J.toString()}else{L=Alfresco.constants.URL_PAGECONTEXT+"document-details?nodeRef="+J.toString();H=Alfresco.constants.URL_PAGECONTEXT+"folder-details?nodeRef="+J.toString()}if(this.options.simpleView){if(D.isFolder){var A=this.id+"-preview-"+M.getId();E='<span id="'+A+'" class="icon32"><a href="'+L+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/filetypes/generic-folder-32.png" alt="'+G+'" title="'+p(z)+'" /></a></span>';this.previewTooltips.push(A)}else{var A=this.id+"-preview-"+M.getId();E='<span id="'+A+'" class="icon32"><a href="'+H+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(z)+'" alt="'+G+'" title="'+p(z)+'" /></a></span>';this.previewTooltips.push(A)}}else{C=100;if(D.isFolder){E='<span class="thumbnail"><a href="'+H+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/filetypes/generic-folder-48.png" title="'+p(z)+'" /></a></span>'}else{var y=Alfresco.constants.PROXY_URI+"api/node/"+J.uri+"/content/thumbnails/doclib?c=queue&ph=true";E='<span class="thumbnail"><a href="'+L+'"><img src="'+y+'" alt="'+G+'" title="'+p(z)+'" /></a></span>'}}}F.width=C;a.setStyle(K,"width",F.width+"px");a.setStyle(K.parentNode,"width",F.width+"px");K.innerHTML=E},renderCellDetail:function r(C,R,E,K){var A=R.getData(),P="";if(A.isInfo){P+='<div class="empty"><h3>'+A.title+"</h3>";P+="<span>"+A.description+"</span></div>"}else{var I=this.id+"-metadata-"+R.getId(),B="",N='<span class="faded">'+this.msg("details.description.none")+"</span>",F="",Q=A.location,D=new Alfresco.util.NodeRef(A.nodeRef),z="",y="",G="";if(Q.site){z=Alfresco.constants.URL_PAGECONTEXT+"site/"+Q.site+"/document-details?nodeRef="+D.toString();y=Alfresco.constants.URL_PAGECONTEXT+"site/"+Q.site+"/folder-details?nodeRef="+D.toString();G=Alfresco.constants.URL_PAGECONTEXT+"site/"+Q.site+"/documentlibrary?path="+Q.path}else{z=Alfresco.constants.URL_PAGECONTEXT+"document-details?nodeRef="+D.toString();y=Alfresco.constants.URL_PAGECONTEXT+"folder-details?nodeRef="+D.toString();G=Alfresco.constants.URL_PAGECONTEXT+"repository?path="+Q.path}if(A.description&&A.description!==""){N=q(p(A.description))}if(A.version&&A.version!==""){B='<span class="document-version">'+p(A.version)+"</span>"}dateI18N="modified";dateProperty=A.modifiedOn;F=this.msg("details."+dateI18N+"-by",d(dateProperty),f(A.modifiedByUser,A.modifiedBy,'class="theme-color-1"'));if(this.options.simpleView){if(A.isFolder){P+='<h3 class="filename simple-view"><a href="'+y+'">'+p(A.displayName)+"</a></h3>";P+='<div class="detail"><span class="item-simple">'+F+"</span></div>"}else{P+='<h3 class="filename simple-view"><a href="'+z+'">'+p(A.displayName)+"</a></h3>";P+='<div class="detail"><span class="item-simple">'+F+"</span></div>"}P+='<div class="detail"><span class="item-simple">'+this.msg("label.inFolder")+'&nbsp;<a href="'+G+'">'+Q.path+"</a></span></div>"}else{if(A.isFolder){P+='<h3 class="filename"><a href="'+y+'">'+p(A.displayName)+"</a></h3>";P+='<div class="detail">';P+='<span class="item-simple">'+this.msg("label.inFolder")+'&nbsp;<a href="'+G+'">'+Q.path+'</a></span>&nbsp;<span class="item">'+F+"</span>"}else{P+='<h3 class="filename"><a href="'+z+'">'+p(A.displayName)+"</a>"+B+"</h3>";P+='<div class="detail">';P+='<span class="item-simple">'+this.msg("label.inFolder")+'&nbsp;<a href="'+G+'">'+Q.path+'</a></span>&nbsp;<span class="item">'+F+"</span>";if(this.options.showFileSize){P+='<span class="item">'+Alfresco.util.formatFileSize(A.size)+"</span>"}}P+="</div>";P+='<div class="detail"><span class="item">'+N+"</span></div>";var J=A.categories,L;P+='<div class="detail">';P+='<span class="item">'+this.msg("label.categories")+":&nbsp;";if(J.length>0){for(var O=0,M=J.length;O<M;O++){L=J[O];P+='<span class="category">'+p(L[0])+"</span>"+(M-O>1?", ":"")}}else{P+='<span class="faded">'+this.msg("details.categories.none")+"</span>"}P+="</span>";P+="</div>";var H=A.tags,S;P+='<div class="detail">';P+='<span class="item">'+this.msg("label.tags")+":&nbsp;";if(H.length>0){for(var O=0,M=H.length;O<M;O++){S=H[O];P+='<span class="tag">'+p(S)+"</span>"+(M-O>1?", ":"")}}else{P+='<span class="faded">'+this.msg("details.tags.none")+"</span>"}P+="</span>";P+="</div>"}this.metadataTooltips.push(I)}C.innerHTML=P}})})();